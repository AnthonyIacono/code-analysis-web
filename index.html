<!-- Welcome!
     ========

     This is a list view for employees that work at WillowTree.


     What it does:
     ~~~~~~~~~~~~~

     - Lists employees photos & names.
     - Search for an employee by name.
     - Sort employees by their first names.
     - Sort empolyees by their last names.
     - Shuffle the list order (because why not).

     Implementation details:
     ~~~~~~~~~~~~~~~~~~~~~~~

     - No compile stepâ€”Just open this file in a browser.
     - The view layer is written in React (without JSX).
       * If you don't know React, don't fret! The logic lives
         outside of it for the most part.


     So... what now?
     ~~~~~~~~~~~~~~~

     Take a look at the code. It works on the surface, but can it be
     improved? Are there things that you would do differently?

     Change it & Have fun!


     Misc. Notes
     ~~~~~~~~~~~

     This code is only expected to work in the latest version of
     Google Chrome. Feel free to use all the latest & greatest
     things that are offered (new API's for JS, CSS, etc.).

     Currently this project does _not_ have a build step (i.e. it runs
     directly by opening the file in Google Chrome). If you finish
     with improvements & feel like there isn't much else to do _then_
     add in a build step if you wish. This is NOT strictly required.

   -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
        <title>Single Page Application</title>

        <style>
        body {
            margin: 0px;
            padding: 0px;
        }

        .app-container {
            width: 400px;
            margin: 0 auto 0 auto;
        }

        .image {
            width: 100px;
            height: 100px;
        }

        .list-container {
            width: 100%;
            border: 1px solid black;
        }
        </style>
    </head>
    <body>
        <!-- Container for our application -->
        <div id="app"></div>


        <!-- 3rd Party Scripts -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-dom.js"></script>


        <!-- Our Application Logic -->
        <script>

        /*==================================================

           API

         ***************************************************/

        /**
         * Get the data from the namegame endpoint.
         *
         * The data comes back in the format:
         *
         *    [
         *        { firstName: 'Viju,  lastName: 'Legard',  headshot: { url: '...' } },
         *        { firstName: 'Matt', lastName: 'Seibert', headshot: { url: '...' } },
         *        ...
         *    ]
         */
        async function getPersonList() {
            let response = await fetch('https://willowtreeapps.com/api/v1.0/profiles');

            if(response.status !== 200) {
                throw new Error("Error!");
            }

            let data = await response.json();

            return data;
        }


        /*==================================================

           DATA TRANSFORMS

         ***************************************************/


        function getLastName(person) {
            return person.lastName.trim();
        }

        const getFirstName = (person) => {
            return person.firstName.trim();
        };

        // headshot URLs are scheme relative //
        // prepend http: to prevent invalid schemes like file:// or uri://
        // instead return null if the person does not have a headshot url defined
        const getImageUrl = (person) => {
            if(person.headshot.url === undefined) {
                return null;
            }

            return `http:${person.headshot.url}`;
        };

        /**
         * Fisher-Yates shuffle
         */
        function shuffleList(list) {
            // Make a copy & don't mutate the passed in list
            let result = list.slice();

            let tmp, j, i = result.length - 1

            for (; i > 0; i -= 1) {
                j = Math.floor(Math.random() * (i + 1));
                tmp = result[i];
                result[i] = result[j];
                result[j] = tmp;
            }

            return result;
        }


        /**
         * Get all the words from a phrase string.
         */
        function getWords(phrase) {
            let words = [];
            let cleanedPhrase = phrase.replace(/[\s]+/g, ' ').trim();

            if(phrase.length === 0 || cleanedPhrase === '') {
                return words;
            }

            words = cleanedPhrase.split(' ');
            return words;
        }

        /**
         * Remove any people that do not have a name that
         * contains one or more words from our search string.
         */
        function filterByName(searchForName, personList) {
            // Get each word from the search query.
            const searchTerms = getWords(searchForName);

            // Filter our list of people...
            return personList.filter((person) => {
                // If there are no search terms, return everyone in our list.
                if(searchTerms.length === 0) {
                    return true;
                }

                // Make sure that one or more search term is found inside 
                return searchTerms.some((searchTerm) => {
                    // Transform our search term into lowercase.
                    searchTerm = searchTerm.trim().toLowerCase();

                    // Check if the first name or last name contains our search term.
                    return getFirstName(person).toLowerCase().indexOf(searchTerm) !== -1 ||
                        getLastName(person).toLowerCase().indexOf(searchTerm) !== -1;
                });
            });
        }

        /**
         * Toggle the value passed in using the following rules:
         * 1. If the current value is null, switch the value to true.
         * 2. Otherwise, switch the value to !value.
         */
        function toggleBool(currentBool) {
            return currentBool === null ? true : !currentBool;
        }

        /**
         * Takes in a property of an object list, e.g. "name" below
         *
         *    people = [{ name: 'Sam' }, { name: 'Jon' }, { name: 'Kevin' }]
         *
         * And returns a function that will sort that list, e.g.
         *
         *    const sortPeopleByName = sortObjListByProp('name');
         *    const sortedPeople = sortPeopleByName(people, true);
         *
         *  We now have:
         *
         *    console.log(sortedPeople)
         *    > [{ name: 'Jon' }, { name: 'Kevin' }, { name: 'Sam' }]
         *
         * You may also sort the list backwards, e.g.
         *
         *    const sortPeopleByName = sortObjListByProp('name');
         *    const sortedPeopleBackwards = sortPeopleByName(people, false);
         *
         *  We now have:
         *
         *    console.log(sortedPeopleBackwards)
         *    > [{ name: 'Sam' }, { name: 'Kevin' }, { name: 'Jon' }]
         */
        function sortObjListByProp(prop) {
            return function(objList, forward) {
                // Make a copy & don't mutate the passed in list
                let result = objList.slice();

                result.sort((a, b) => {
                    if (a[prop] < b[prop]) {
                        return forward ? -1 : 1;
                    }

                    if (a[prop] > b[prop]) {
                        return forward ? 1 : -1;
                    }

                    return 0;
                });

                return result;
            };
        }

        const sortByFirstName = sortObjListByProp('firstName');

        const sortByLastName = sortObjListByProp('lastName');


        /*==================================================

           VIEW (React)

         ***************************************************/

        const Search = (props) => React.DOM.input({
            type: 'input',
            onChange: props.onChange
        });

        const Thumbnail = (props) => React.DOM.img({
            className: 'image',
            src: props.src
        });

        const NotPictured = (props) => React.DOM.span({
            className: 'not-pictured',
            children: 'Not Pictured'
        });

        const ListRow = (props) => {
            const imageUrl = getImageUrl(props.person);
            const imageElement = imageUrl === null ? NotPictured : Thumbnail;
            
            return React.DOM.tr({ key: `${props.person.firstName} ${props.person.lastName}` }, [
                React.DOM.td({ key: 'thumb' }, React.createElement(imageElement, { src: imageUrl })),
                React.DOM.td({ key: 'first' }, null, getFirstName(props.person)),
                React.DOM.td({ key: 'last' }, null, getLastName(props.person)),
            ]);
        };

        const ListContainer = (props) => React.DOM.table({ className: 'list-container' }, [
            React.DOM.thead({ key: 'thead' }, React.DOM.tr({}, [
                React.DOM.th({ key: 'thumb-h' }, null, 'Thumbnail'),
                React.DOM.th({ key: 'first-h' }, null, 'First Name'),
                React.DOM.th({ key: 'last-h' }, null, 'Last Name')
            ])),
            React.DOM.tbody({ key: 'tbody' }, props.personList.map((person, i) =>
                React.createElement(ListRow, { key: `person-${i}`, person })))
        ]);

        const App = React.createClass({
            getInitialState() {
                return {
                    personList: [],
                    visiblePersonList: [],
                    sortFirstForward: null,
                    sortLastForward: null,
                    searchQuery: ''
                };
            },

            componentDidMount() {
                getPersonList().then((personList) =>
                    this.setState({
                        personList,
                        visiblePersonList: personList
                    }));
            },

            _shuffleList() {
                const searchResults = filterByName(this.state.searchQuery, this.state.personList);

                this.setState({
                    visiblePersonList: shuffleList(searchResults)
                });
            },

            _sortByFirst() {
                const searchResults = filterByName(this.state.searchQuery, this.state.personList);

                const newSortFirstForward = toggleBool(this.state.sortFirstForward);

                this.setState({
                    sortFirstForward: newSortFirstForward,
                    sortLastForward: null,
                    visiblePersonList: sortByFirstName(searchResults, newSortFirstForward)
                });
            },

            _sortByLast() {
                const searchResults = filterByName(this.state.searchQuery, this.state.personList);

                const newSortLastForward = toggleBool(this.state.sortLastForward);

                this.setState({
                    sortFirstForward: null,
                    sortLastForward: newSortLastForward,
                    visiblePersonList: sortByLastName(searchResults, newSortLastForward)
                });
            },

            _onSearch(e) {
                this.setState({
                    searchQuery: e.target.value,
                    visiblePersonList: filterByName(e.target.value, this.state.personList)
                });
            },

            render() {
                return React.DOM.div({ className: 'app-container' }, [
                    React.createElement(Search, { key: 'search', onChange: this._onSearch }),
                    React.DOM.button({ key: 'shuffle', onClick: this._shuffleList }, null, 'Shuffle'),
                    React.DOM.button({ key: 'sort-first', onClick: this._sortByFirst }, null, 'Sort (First Name)'),
                    React.DOM.button({ key: 'sort-last', onClick: this._sortByLast }, null, 'Sort (Last Name)'),
                    React.createElement(ListContainer, { key: 'list', personList: this.state.visiblePersonList })
                ]);
            }
        });

        ReactDOM.render(
            React.createElement(App),
            document.getElementById('app')
        );

        </script>
    </body>
</html>
